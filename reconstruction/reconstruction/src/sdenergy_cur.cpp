// June 2010 energy estimation routine
// Dmitri Ivanov <ivanov@physics.rutgers.edu>
// Last Modified: Jun 24, 2010

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>



#define sden_jun2010_nfpars   9
#define sden_jun2010_nsecbins 50
#define sden_jun2010_seclo    1.000000
#define sden_jun2010_secup    2.000000
/* par[0-7]: pol7 fit parameters */
/* par[8]: point where the function becomes pol1 */
static double sden_jun2010_fitfun(double *x, const double *par)
{
  double delta=x[0]-par[8];
  return
    (
     (delta < 0) ?
     (par[0]+delta*(par[1]+delta*(par[2]+delta*(par[3]+delta*(par[4]+delta*(par[5]+delta*(par[6]+delta*par[7])))))))
     :
     (par[0]+par[1]*delta)
     );
}
double sden_jun2010(double s800, double theta)
{
  static const double secbs = (sden_jun2010_secup-sden_jun2010_seclo)/(double)sden_jun2010_nsecbins;
  static const double fpars[sden_jun2010_nsecbins][sden_jun2010_nfpars] = {
    {   19.036835,    1.095040,   -2.622812,   -6.002011,   -1.961494,    2.125823,   -0.325346,   -0.908887,    1.500000   },
    {   19.036437,    1.089423,   -2.165791,   -4.874252,   -1.602394,    1.709322,   -0.242571,   -0.724306,    1.500000   },
    {   19.041865,    1.086377,   -0.406593,    3.881487,   11.797030,    6.217179,   -4.618365,   -3.172074,    1.500000   },
    {   19.040085,    1.093520,    0.301508,    5.622068,   12.379965,    5.540826,   -4.497819,   -2.869689,    1.500000   },
    {   19.044969,    1.098996,    0.906644,    7.309569,   13.028243,    4.786414,   -4.363564,   -2.506649,    1.500000   },
    {   19.064169,    1.084602,    0.344487,    5.907487,   12.537545,    5.358695,   -4.462857,   -2.767270,    1.500000   },
    {   19.063567,    1.096842,    1.155320,    7.913797,   13.173542,    4.555852,   -4.301732,   -2.405232,    1.500000   },
    {   19.073521,    1.089345,    1.092722,    7.836153,   13.215802,    4.549817,   -4.312956,   -2.389177,    1.500000   },
    {   19.085806,    1.086743,    1.232721,    8.092414,   13.214075,    4.472429,   -4.277292,   -2.362754,    1.500000   },
    {   19.094783,    1.090846,    1.304245,    8.118107,   13.193017,    4.479994,   -4.276434,   -2.367275,    1.500000   },
    {   19.105097,    1.092245,    1.716338,    9.138876,   13.521981,    4.067597,   -4.196135,   -2.179869,    1.500000   },
    {   19.114066,    1.099946,    2.057422,    9.844336,   13.674061,    3.807399,   -4.129163,   -2.069101,    1.500000   },
    {   19.129940,    1.099553,    2.140905,   10.064623,   13.768914,    3.713618,   -4.118050,   -2.023464,    1.500000   },
    {   19.143278,    1.100770,    2.260815,   10.299309,   13.808149,    3.641149,   -4.101102,   -1.998225,    1.500000   },
    {   19.157361,    1.098484,    2.789752,   12.439112,   16.407962,    3.851807,   -5.433977,   -2.562117,    1.500000   },
    {   19.181617,    1.087130,    1.422172,    6.378897,    8.155492,    1.901011,   -2.402734,   -1.100041,    1.500000   },
    {   19.202318,    1.088466,    0.928355,    4.147263,    5.197718,    1.254289,   -1.379818,   -0.630161,    1.500000   },
    {   19.226362,    1.081841,    0.709878,    3.617163,    5.057239,    1.484507,   -1.441236,   -0.737120,    1.500000   },
    {   19.248609,    1.078070,    0.950233,    4.228099,    5.235229,    1.247010,   -1.392345,   -0.633628,    1.500000   },
    {   19.268724,    1.082384,    1.153828,    4.594629,    5.288101,    1.129849,   -1.362026,   -0.590469,    1.500000   },
    {   19.291498,    1.082797,    1.347300,    4.987120,    5.359301,    0.956328,   -1.313833,   -0.510878,    1.500000   },
    {   19.318810,    1.071961,    0.976039,    4.142588,    5.127624,    1.295886,   -1.396379,   -0.664988,    1.500000   },
    {   19.341378,    1.079761,    0.535298,    2.530317,    3.370328,    1.058494,   -0.810257,   -0.428343,    1.500000   },
    {   19.365092,    1.080471,   -0.020113,   -0.048100,   -0.043654,    0.496064,    0.705617,    0.258160,    1.500000   },
    {   19.392100,    1.075250,    0.117706,    0.552188,    0.790920,    0.870925,    0.634025,    0.192721,    1.500000   },
    {   19.410728,    1.078997,    0.555130,    1.383895,    0.891711,    0.570994,    0.739733,    0.320436,    1.500000   },
    {   19.435344,    1.073050,    0.016857,   -1.022427,   -2.193346,    0.158153,    2.112885,    0.911667,    1.500000   },
    {   19.451819,    1.081267,    0.743902,    1.624450,    0.706729,    0.309894,    0.826177,    0.418848,    1.500000   },
    {   19.465256,    1.094224,    0.478292,   -0.168136,   -1.920897,   -0.121499,    2.078513,    0.985676,    1.500000   },
    {   19.496745,    1.084339,   -0.368247,   -3.007591,   -4.435897,    0.369424,    3.445368,    1.385651,    1.500000   },
    {   19.532547,    1.055641,   -0.735292,   -3.533355,   -4.434810,    0.537668,    3.369041,    1.320448,    1.500000   },
    {   19.556507,    1.059091,   -1.571920,   -7.052909,   -8.608372,    0.167986,    5.164707,    2.031397,    1.500000   },
    {   19.583843,    1.065864,   -2.461701,  -10.403728,  -12.405512,   -0.139771,    6.876079,    2.729737,    1.500000   },
    {   19.604126,    1.079349,   -2.485497,  -10.529443,  -12.416436,   -0.054907,    6.840934,    2.687056,    1.500000   },
    {   19.614660,    1.100917,   -0.730486,   -4.601945,   -6.449257,    0.301650,    4.602948,    1.863620,    1.500000   },
    {   19.656205,    1.065812,   -1.090303,   -5.295336,   -6.561389,    0.592776,    4.505426,    1.731088,    1.500000   },
    {   19.691231,    1.030024,   -1.731652,   -7.160482,   -8.579444,    0.395119,    5.560397,    2.213466,    1.500000   },
    {   19.706703,    1.049431,   -1.015467,   -3.956465,   -3.960473,    1.614202,    3.865177,    1.370710,    1.500000   },
    {   19.735980,    1.064224,   -2.287530,   -9.185544,   -9.838841,    1.792478,    7.265153,    2.682193,    1.500000   },
    {   19.750409,    1.086181,   -1.733484,   -6.763854,   -6.456021,    2.485869,    5.826546,    2.010784,    1.500000   },
    {   19.779442,    1.070415,   -1.890467,   -7.173699,   -6.596237,    2.687407,    5.778225,    1.910820,    1.500000   },
    {   19.799970,    1.091333,   -1.505068,   -6.366479,   -6.409944,    2.326499,    5.882689,    2.086731,    1.500000   },
    {   19.833215,    1.064914,   -1.855022,   -6.978919,   -6.527866,    2.565841,    5.819209,    1.982252,    1.500000   },
    {   19.863479,    1.030353,   -2.076285,   -7.213981,   -6.511792,    2.620964,    5.799883,    1.971732,    1.500000   },
    {   19.896810,    1.043816,   -1.959507,   -6.856429,   -6.406161,    2.454325,    5.859220,    2.062170,    1.500000   },
    {   19.906914,    1.096534,    0.605560,    3.357960,    6.256448,    4.582201,    0.841430,   -0.160770,    1.500000   },
    {   19.930409,    1.061097,   -0.192372,    0.689989,    3.634087,    4.879636,    2.383351,    0.384403,    1.500000   },
    {   19.963765,    1.007463,   -3.050813,   -9.886591,   -8.032181,    4.354792,    7.889524,    2.551219,    1.500000   },
    {   19.941674,    1.122108,    6.033493,   41.079520,  104.693949,  123.805290,   68.535948,   14.410942,    1.500000   },
    {   19.967352,    1.122583,    5.144269,   37.171741,   99.408901,  122.880919,   70.969093,   15.534200,    1.500000   }
  };
  double log10en;
  double log10s800=log(s800)/2.3025851;
  int isectheta=(int)floor((1.0/cos(theta/57.2957895)-sden_jun2010_seclo)/secbs);
  if(isectheta<0) isectheta=0;
  if(isectheta>=sden_jun2010_nsecbins) isectheta=(sden_jun2010_nsecbins-1);
  log10en=sden_jun2010_fitfun(&log10s800,fpars[isectheta]);
  return pow(10.0,log10en-18.0);
}
